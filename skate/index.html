<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Toronto Drop-in Skating</title>
    
    <!-- No caching -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <style>
        /* ========== MOBILE-FIRST BASE ========== */
        :root {
            --primary: #4a9;
            --primary-dark: #3a8;
            --danger: #c55;
            --text: #222;
            --text-muted: #666;
            --bg: #f5f5f5;
            --bg-white: #fff;
            --border: #ddd;
            --border-dark: #ccc;
            --bubble-mine: #dcf8c6;
            --bubble-other: #fff;
            --bubble-system: #f0f0f0;
            --bubble-shared: #e3f2fd;
            --radius: 8px;
            --radius-lg: 16px;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html, body {
            height: 100%;
            overflow: hidden;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            font-size: 14px;
            line-height: 1.4;
            background: var(--bg);
            color: var(--text);
        }
        
        button {
            font-family: inherit;
            cursor: pointer;
            border: none;
            background: var(--bg);
            padding: 8px 12px;
            border-radius: var(--radius);
            font-size: 14px;
            transition: background 0.15s, transform 0.1s;
        }
        
        button:active { transform: scale(0.97); }
        
        input, select {
            font-family: inherit;
            font-size: 14px;
            padding: 8px 12px;
            border: 1px solid var(--border-dark);
            border-radius: var(--radius);
            background: var(--bg-white);
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* ========== APP LAYOUT ========== */
        .app {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        /* Top bar */
        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--bg-white);
            border-bottom: 1px solid var(--border);
            gap: 10px;
            flex-shrink: 0;
        }
        
        .top-bar h1 {
            font-size: 16px;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .top-bar-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: #fff;
        }
        
        .btn-primary:hover { background: var(--primary-dark); }
        
        .btn-danger {
            background: var(--danger);
            color: #fff;
        }
        
        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            background: var(--bg);
            border: 1px solid var(--border);
        }
        
        /* Tabs for switching views */
        .view-tabs {
            display: flex;
            background: var(--bg-white);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        
        .view-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            background: none;
            border-radius: 0;
            border-bottom: 2px solid transparent;
            color: var(--text-muted);
            font-weight: 500;
        }
        
        .view-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .view-tab .badge {
            background: var(--primary);
            color: #fff;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 4px;
        }
        
        /* Main content area */
        .main-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        .view-panel {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            display: none;
            padding: 10px;
        }
        
        .view-panel.active { display: block; }
        
        /* ========== PROGRAMS VIEW ========== */
        .search-box {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .search-box input { flex: 1; }
        
        .filter-row {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .filter-chip {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 15px;
            background: var(--bg-white);
            border: 1px solid var(--border);
            color: var(--text-muted);
        }
        
        .filter-chip.active {
            background: var(--text);
            color: #fff;
            border-color: var(--text);
        }
        
        .filter-selects {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .filter-selects select {
            flex: 1;
            max-width: 150px;
        }
        
        .stats-row {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }
        
        .program-list {
            list-style: none;
        }
        
        .program-item {
            background: var(--bg-white);
            border-radius: var(--radius);
            padding: 10px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
        }
        
        .program-item:active { background: #ffffd0; }
        
        .program-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
        }
        
        .program-title {
            font-weight: 600;
            color: #0066cc;
            font-size: 14px;
        }
        
        .program-meta {
            text-align: right;
            font-size: 12px;
            color: var(--text-muted);
            white-space: nowrap;
        }
        
        .program-date { font-weight: 600; color: var(--text); }
        
        .program-location {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 4px;
        }
        
        .program-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
        }
        
        .tag {
            display: inline-block;
            padding: 2px 6px;
            font-size: 10px;
            border-radius: 3px;
            background: #eee;
            text-transform: uppercase;
            font-weight: 500;
        }
        
        .tag.shinny { background: #ffe0e6; color: #c44; }
        .tag.figure { background: #e0e6ff; color: #44c; }
        .tag.speed { background: #fff5e0; color: #a84; }
        
        .program-actions {
            display: flex;
            gap: 6px;
        }
        
        .program-actions button {
            padding: 4px 10px;
            font-size: 12px;
        }
        
        .btn-vote.voted {
            background: var(--primary);
            color: #fff;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            gap: 4px;
            padding: 10px 0;
            flex-wrap: wrap;
        }
        
        .pagination button {
            min-width: 36px;
            height: 36px;
            padding: 0;
        }
        
        .pagination button.active {
            background: var(--text);
            color: #fff;
        }
        
        /* ========== GROUPS VIEW ========== */
        .groups-list {
            list-style: none;
        }
        
        .group-item {
            background: var(--bg-white);
            border-radius: var(--radius);
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .group-item.active {
            border-color: var(--primary);
            background: #f0fff4;
        }
        
        .group-info h3 {
            font-size: 14px;
            font-weight: 600;
        }
        
        .group-info .group-code {
            font-size: 12px;
            color: var(--text-muted);
            font-family: monospace;
        }
        
        .group-info .group-members {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .group-actions {
            display: flex;
            gap: 6px;
        }
        
        .create-group-card {
            background: var(--bg-white);
            border-radius: var(--radius);
            padding: 16px;
            border: 2px dashed var(--border);
            text-align: center;
        }
        
        .create-group-card h3 {
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .create-group-card p {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }
        
        .create-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .create-options input {
            text-align: center;
        }
        
        .create-options .btn-primary {
            padding: 12px;
            font-size: 15px;
        }
        
        .share-card {
            background: #fffde7;
            border-radius: var(--radius);
            padding: 12px;
            margin-top: 12px;
            border: 1px solid #e6d88a;
        }
        
        .share-card label {
            font-size: 12px;
            color: var(--text-muted);
            display: block;
            margin-bottom: 6px;
        }
        
        .share-card input {
            width: 100%;
            font-size: 12px;
            margin-bottom: 8px;
        }
        
        /* ========== CHAT VIEW ========== */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .chat-header {
            padding: 10px 12px;
            background: var(--bg-white);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-header-info h3 {
            font-size: 14px;
            font-weight: 600;
        }
        
        .chat-header-info .status {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 4px;
        }
        
        .status-dot.online { background: var(--primary); }
        .status-dot.offline { background: #ccc; }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: #fafafa;
        }
        
        .chat-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }
        
        .chat-msg {
            margin-bottom: 8px;
            max-width: 85%;
        }
        
        .chat-msg.mine {
            margin-left: auto;
            text-align: right;
        }
        
        .chat-msg .sender {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 2px;
        }
        
        .chat-msg .bubble {
            display: inline-block;
            padding: 8px 12px;
            background: var(--bubble-other);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            font-size: 14px;
            text-align: left;
            word-break: break-word;
        }
        
        .chat-msg.mine .bubble {
            background: var(--bubble-mine);
            border-color: #c5e1a5;
        }
        
        .chat-msg.system {
            text-align: center;
            max-width: 100%;
        }
        
        .chat-msg.system .bubble {
            background: var(--bubble-system);
            color: var(--text-muted);
            font-size: 12px;
            border: none;
            padding: 4px 10px;
        }
        
        .chat-msg.share .bubble {
            background: var(--bubble-shared);
            border-color: #90caf9;
        }
        
        .chat-msg .subtext {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }
        
        .chat-msg .dm-btn {
            font-size: 11px;
            padding: 2px 6px;
            margin-left: 4px;
        }
        
        .chat-input-bar {
            padding: 10px;
            background: var(--bg-white);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
        }
        
        .chat-input-bar input {
            flex: 1;
            border-radius: 20px;
            padding: 10px 16px;
        }
        
        .chat-input-bar button {
            width: 44px;
            height: 44px;
            border-radius: 22px;
            background: var(--primary);
            color: #fff;
            font-size: 18px;
            padding: 0;
        }
        
        .members-bar {
            padding: 8px 12px;
            background: #f0f0f0;
            font-size: 12px;
            color: var(--text-muted);
            border-top: 1px solid var(--border);
        }
        
        .member-chip {
            display: inline-block;
            padding: 2px 8px;
            background: var(--bg-white);
            border-radius: 10px;
            margin: 2px;
            font-size: 11px;
            cursor: pointer;
        }
        
        .member-chip:hover { background: #e0e0e0; }
        
        /* ========== PASSWORD MODAL ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 1000;
        }
        
        .modal-overlay.hidden { display: none; }
        
        .modal {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 20px;
            max-width: 320px;
            width: 100%;
        }
        
        .modal h3 {
            font-size: 16px;
            margin-bottom: 12px;
        }
        
        .modal p {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }
        
        .modal input {
            width: 100%;
            margin-bottom: 12px;
        }
        
        .modal-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        /* ========== DESKTOP ENHANCEMENTS ========== */
        @media (min-width: 768px) {
            .app {
                flex-direction: row;
            }
            
            .view-tabs { display: none; }
            
            .main-content {
                display: flex;
            }
            
            .view-panel {
                position: relative;
                display: block;
                flex: 1;
                border-right: 1px solid var(--border);
            }
            
            .view-panel.chat-panel-view {
                max-width: 380px;
                flex: 0 0 380px;
                border-right: none;
            }
            
            .view-panel.groups-panel-view {
                max-width: 280px;
                flex: 0 0 280px;
            }
        }
        
        /* ========== UTILITY ========== */
        .hidden { display: none !important; }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: var(--danger);
        }
    </style>
</head>
<body>
    <div class="app" id="app">
        <!-- Top Bar -->
        <div class="top-bar">
            <h1>üõº Toronto Skating</h1>
            <div class="top-bar-actions">
                <button class="btn-icon" id="btn-share" title="Share Group">üì§</button>
                <button class="btn-primary" id="btn-new-group">+ Group</button>
            </div>
        </div>
        
        <!-- Mobile Tabs -->
        <div class="view-tabs">
            <button class="view-tab active" data-view="programs">
                üõº Programs
            </button>
            <button class="view-tab" data-view="groups">
                üë• Groups <span class="badge hidden" id="groups-badge">0</span>
            </button>
            <button class="view-tab" data-view="chat">
                üí¨ Chat <span class="badge hidden" id="chat-badge">0</span>
            </button>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Programs Panel -->
            <div class="view-panel active" id="programs-panel">
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="Search activities or locations...">
                    <button id="btn-search">üîç</button>
                </div>
                
                <div class="filter-row" id="type-filters">
                    <button class="filter-chip active" data-type="all">All</button>
                    <button class="filter-chip" data-type="leisure">Leisure</button>
                    <button class="filter-chip" data-type="shinny">Shinny</button>
                    <button class="filter-chip" data-type="figure">Figure</button>
                    <button class="filter-chip" data-type="speed">Speed</button>
                </div>
                
                <div class="filter-selects">
                    <select id="day-filter">
                        <option value="">Any Day</option>
                        <option>Sunday</option>
                        <option>Monday</option>
                        <option>Tuesday</option>
                        <option>Wednesday</option>
                        <option>Thursday</option>
                        <option>Friday</option>
                        <option>Saturday</option>
                    </select>
                    <input type="number" id="age-filter" placeholder="Age" style="max-width:80px">
                </div>
                
                <div class="stats-row" id="stats-row">Loading...</div>
                
                <ul class="program-list" id="program-list">
                    <li class="loading">Loading programs...</li>
                </ul>
                
                <div class="pagination" id="pagination"></div>
            </div>
            
            <!-- Groups Panel -->
            <div class="view-panel groups-panel-view" id="groups-panel">
                <div class="create-group-card" id="create-group-card">
                    <h3>üõº Start a Skating Group</h3>
                    <p>Create a group and invite friends to coordinate skating times!</p>
                    <div class="create-options">
                        <input type="text" id="group-name-input" placeholder="Group name (optional)">
                        <input type="password" id="group-password-input" placeholder="Password (optional)">
                        <button class="btn-primary" id="btn-create-group">Create Group</button>
                    </div>
                </div>
                
                <div class="share-card hidden" id="share-card">
                    <label>üìã Share this link with friends:</label>
                    <input type="text" id="share-url-input" readonly>
                    <button id="btn-copy-url" style="width:100%">Copy Link</button>
                </div>
                
                <h4 style="margin:16px 0 8px;font-size:13px;color:var(--text-muted)">Your Groups</h4>
                <ul class="groups-list" id="groups-list">
                    <li class="loading" style="text-align:center;padding:20px;color:var(--text-muted)">
                        No groups yet
                    </li>
                </ul>
            </div>
            
            <!-- Chat Panel -->
            <div class="view-panel chat-panel-view" id="chat-panel">
                <div class="chat-container" id="chat-container">
                    <div class="chat-header">
                        <div class="chat-header-info">
                            <h3 id="chat-group-name">No group selected</h3>
                            <div class="status">
                                <span class="status-dot" id="chat-status-dot"></span>
                                <span id="chat-status-text">--</span>
                            </div>
                        </div>
                        <button class="btn-icon" id="btn-chat-share" title="Share Group">üì§</button>
                    </div>
                    
                    <div class="chat-messages" id="chat-messages">
                        <div class="chat-empty">
                            <p>üë• Join or create a group to start chatting!</p>
                        </div>
                    </div>
                    
                    <div class="members-bar hidden" id="members-bar">
                        <span id="members-list"></span>
                    </div>
                    
                    <div class="chat-input-bar hidden" id="chat-input-bar">
                        <input type="text" id="chat-input" placeholder="Type a message...">
                        <button id="btn-send">‚û§</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Password Modal -->
    <div class="modal-overlay hidden" id="password-modal">
        <div class="modal">
            <h3>üîí Password Required</h3>
            <p>This group requires a password to join.</p>
            <input type="password" id="modal-password-input" placeholder="Enter password">
            <div class="modal-actions">
                <button id="btn-modal-cancel">Cancel</button>
                <button class="btn-primary" id="btn-modal-join">Join</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="projects/js/storage.js?v=4"></script>
    <script src="projects/js/api.js?v=4"></script>
    <script src="projects/js/filters.js?v=4"></script>
    <script src="projects/js/utils.js?v=4"></script>
    <script src="projects/js/chat-config.js?v=4"></script>
    <script src="projects/js/chat-crypto.js?v=4"></script>
    <script src="projects/js/chat-network.js?v=4"></script>
    <script src="projects/js/chat-state.js?v=4"></script>
    <script src="projects/js/chat-main.js?v=4"></script>
    
    <script>
    (function() {
        'use strict';
        
        // ========== STATE ==========
        const state = {
            programs: [],
            filtered: [],
            page: 1,
            perPage: 25,
            type: 'all',
            search: '',
            day: '',
            age: null,
            activeView: 'programs'
        };
        
        // ========== DOM REFS ==========
        const $ = id => document.getElementById(id);
        const $$ = sel => document.querySelectorAll(sel);
        
        // Programs
        const searchInput = $('search-input');
        const dayFilter = $('day-filter');
        const ageFilter = $('age-filter');
        const statsRow = $('stats-row');
        const programList = $('program-list');
        const pagination = $('pagination');
        
        // Groups
        const groupsList = $('groups-list');
        const shareCard = $('share-card');
        const shareUrlInput = $('share-url-input');
        
        // Chat
        const chatMessages = $('chat-messages');
        const chatInput = $('chat-input');
        const chatInputBar = $('chat-input-bar');
        const membersBar = $('members-bar');
        
        // Modal
        const passwordModal = $('password-modal');
        
        // ========== INIT ==========
        async function init() {
            try {
                // Load programs
                const programs = await SkateAPI.getSkatingPrograms();
                if (!programs?.length) throw new Error('No programs found');
                
                state.programs = programs;
                state.filtered = programs;
                
                applyFilters();
                bindEvents();
                
                // Init chat
                SkateChat.init();
                SkateChat.onUpdate(updateChatUI);
                
                // Check for pending password join
                checkPendingJoin();
                
            } catch (err) {
                programList.innerHTML = `<li class="error">Error: ${err.message}</li>`;
                console.error(err);
            }
        }
        
        // ========== VIEW SWITCHING ==========
        function switchView(view) {
            state.activeView = view;
            
            $$('.view-tab').forEach(t => t.classList.toggle('active', t.dataset.view === view));
            $$('.view-panel').forEach(p => p.classList.remove('active'));
            
            $(`${view}-panel`).classList.add('active');
        }
        
        // ========== PROGRAMS ==========
        function applyFilters() {
            let result = state.programs;
            
            if (state.type !== 'all') {
                result = result.filter(p => {
                    const act = (p.Activity || p['Activity Title'] || '').toLowerCase();
                    return act.includes(state.type);
                });
            }
            
            if (state.search) {
                const term = state.search.toLowerCase();
                result = result.filter(p => {
                    const act = (p.Activity || p['Activity Title'] || '').toLowerCase();
                    const loc = (p.LocationName || p['Location Name'] || '').toLowerCase();
                    return act.includes(term) || loc.includes(term);
                });
            }
            
            if (state.day) {
                result = result.filter(p => p['Day of Week'] === state.day);
            }
            
            if (state.age !== null) {
                result = result.filter(p => {
                    const min = p['Age Min'] || 0;
                    const max = p['Age Max'] || 999;
                    return state.age >= min && state.age <= max;
                });
            }
            
            // Upcoming only
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            
            result = result.filter(p => {
                const dateStr = p['Start Date Time'] || p['Start Date'];
                if (!dateStr) return true;
                return new Date(dateStr) >= now;
            });
            
            result.sort((a, b) => {
                const da = new Date(a['Start Date Time'] || a['Start Date'] || '9999');
                const db = new Date(b['Start Date Time'] || b['Start Date'] || '9999');
                return da - db;
            });
            
            state.filtered = result;
            state.page = 1;
            renderPrograms();
        }
        
        function renderPrograms() {
            const { filtered, page, perPage } = state;
            const total = filtered.length;
            const start = (page - 1) * perPage;
            const items = filtered.slice(start, start + perPage);
            
            statsRow.textContent = `${total} programs found`;
            
            if (total === 0) {
                programList.innerHTML = '<li class="loading">No programs match your filters</li>';
                pagination.innerHTML = '';
                return;
            }
            
            const chatState = SkateChat.getState();
            programList.innerHTML = items.map((p, i) => renderProgram(p, start + i, chatState)).join('');
            renderPagination(total);
        }
        
        function renderProgram(p, idx, chatState) {
            const activity = p.Activity || p['Activity Title'] || 'Unknown';
            const location = p.LocationName || p['Location Name'] || '';
            const dateStr = p['Start Date Time'] || p['Start Date'] || '';
            const startTime = p['Start Time'] || '';
            const endTime = p['End Time'] || '';
            const ageMin = p['Age Min'];
            const ageMax = p['Age Max'];
            
            let dateDisplay = p['Day of Week'] || '';
            if (dateStr) {
                const d = new Date(dateStr);
                dateDisplay = d.toLocaleDateString('en-CA', { weekday: 'short', month: 'short', day: 'numeric' });
            }
            
            const timeDisplay = startTime + (endTime ? `-${endTime}` : '');
            
            let ageDisplay = 'All ages';
            if (ageMin || ageMax) {
                if (ageMin && ageMax) ageDisplay = `${ageMin}-${ageMax}`;
                else if (ageMin) ageDisplay = `${ageMin}+`;
                else ageDisplay = `Under ${ageMax}`;
            }
            
            const actLower = activity.toLowerCase();
            let tag = '';
            if (actLower.includes('shinny') || actLower.includes('hockey') || actLower.includes('stick')) {
                tag = '<span class="tag shinny">Shinny</span>';
            } else if (actLower.includes('figure')) {
                tag = '<span class="tag figure">Figure</span>';
            } else if (actLower.includes('speed')) {
                tag = '<span class="tag speed">Speed</span>';
            }
            
            // Votes
            let voteCount = 0;
            let hasVoted = false;
            if (chatState.activeGroup && chatState.activeGroup.votes[idx]) {
                voteCount = chatState.activeGroup.votes[idx].length;
                hasVoted = chatState.activeGroup.votes[idx].includes(chatState.myName);
            }
            
            const actions = chatState.activeGroup ? `
                <div class="program-actions">
                    <button onclick="shareProgram(${idx})" title="Share">üì§</button>
                    <button class="btn-vote ${hasVoted ? 'voted' : ''}" onclick="voteTime(${idx})">
                        üëç ${voteCount || ''}
                    </button>
                </div>
            ` : '';
            
            return `
                <li class="program-item">
                    <div class="program-header">
                        <div>
                            <div class="program-title">${activity}</div>
                            <div class="program-location">üìç ${location}</div>
                        </div>
                        <div class="program-meta">
                            <div class="program-date">${dateDisplay}</div>
                            <div>${timeDisplay}</div>
                        </div>
                    </div>
                    <div class="program-footer">
                        <div>${tag} <span style="color:var(--text-muted);font-size:12px">${ageDisplay}</span></div>
                        ${actions}
                    </div>
                </li>
            `;
        }
        
        function renderPagination(total) {
            const totalPages = Math.ceil(total / state.perPage);
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let html = `<button ${state.page === 1 ? 'disabled' : ''} data-p="${state.page - 1}">‚Äπ</button>`;
            
            for (let i = 1; i <= Math.min(totalPages, 5); i++) {
                const p = state.page <= 3 ? i : 
                          state.page >= totalPages - 2 ? totalPages - 5 + i :
                          state.page - 3 + i;
                if (p >= 1 && p <= totalPages) {
                    html += `<button class="${p === state.page ? 'active' : ''}" data-p="${p}">${p}</button>`;
                }
            }
            
            html += `<button ${state.page === totalPages ? 'disabled' : ''} data-p="${state.page + 1}">‚Ä∫</button>`;
            pagination.innerHTML = html;
        }
        
        // ========== CHAT UI ==========
        function updateChatUI(chatState) {
            // Update groups list
            renderGroups(chatState);
            
            // Update chat
            renderChat(chatState);
            
            // Update badges
            const groupCount = Object.keys(chatState.groups).length;
            const groupsBadge = $('groups-badge');
            if (groupCount > 0) {
                groupsBadge.textContent = groupCount;
                groupsBadge.classList.remove('hidden');
            } else {
                groupsBadge.classList.add('hidden');
            }
            
            // Re-render programs for vote counts
            renderPrograms();
        }
        
        function renderGroups(chatState) {
            const groups = Object.values(chatState.groups);
            
            if (groups.length === 0) {
                groupsList.innerHTML = '<li style="text-align:center;padding:20px;color:var(--text-muted)">No groups yet</li>';
                return;
            }
            
            groupsList.innerHTML = groups.map(g => `
                <li class="group-item ${g.id === chatState.activeGroupId ? 'active' : ''}" data-id="${g.id}">
                    <div class="group-info">
                        <h3>${g.name || 'Skating Group'}</h3>
                        <div class="group-code">#${g.id.slice(0, 6).toUpperCase()}</div>
                        <div class="group-members">${g.members.length} members</div>
                    </div>
                    <div class="group-actions">
                        <button class="btn-icon" onclick="selectGroup('${g.id}')" title="Select">
                            ${g.id === chatState.activeGroupId ? '‚úì' : '‚Üí'}
                        </button>
                        <button class="btn-icon" onclick="leaveGroup('${g.id}')" title="Leave">‚úï</button>
                    </div>
                </li>
            `).join('');
            
            // Update share card
            if (chatState.activeGroup) {
                shareCard.classList.remove('hidden');
                shareUrlInput.value = SkateChat.getShareUrl();
            }
        }
        
        function renderChat(chatState) {
            const group = chatState.activeGroup;
            
            if (!group) {
                $('chat-group-name').textContent = 'No group selected';
                $('chat-status-dot').className = 'status-dot offline';
                $('chat-status-text').textContent = 'Not connected';
                chatMessages.innerHTML = '<div class="chat-empty"><p>üë• Join or create a group to start chatting!</p></div>';
                chatInputBar.classList.add('hidden');
                membersBar.classList.add('hidden');
                return;
            }
            
            $('chat-group-name').textContent = group.name || 'Skating Group';
            const status = ChatNetwork.getStatus(group.id);
            $('chat-status-dot').className = `status-dot ${status === 'connected' ? 'online' : 'offline'}`;
            $('chat-status-text').textContent = `#${group.id.slice(0, 6).toUpperCase()} ‚Ä¢ ${status}`;
            
            // Messages
            if (group.messages.length === 0) {
                chatMessages.innerHTML = '<div class="chat-empty"><p>No messages yet. Share a skating session!</p></div>';
            } else {
                chatMessages.innerHTML = group.messages.map(m => {
                    let classes = 'chat-msg';
                    if (m.mine) classes += ' mine';
                    if (m.system) classes += ' system';
                    if (m.type === 'share') classes += ' share';
                    
                    const dmBtn = !m.mine && !m.system ? 
                        `<button class="dm-btn" onclick="startDM('${m.from}')">DM</button>` : '';
                    
                    return `
                        <div class="${classes}">
                            ${!m.mine && !m.system ? `<div class="sender">${m.from} ${dmBtn}</div>` : ''}
                            <div class="bubble">
                                ${m.text}
                                ${m.subtext ? `<div class="subtext">${m.subtext}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Members
            if (group.members.length > 0) {
                membersBar.classList.remove('hidden');
                $('members-list').innerHTML = group.members.slice(0, 10).map(m => 
                    `<span class="member-chip" onclick="startDM('${m}')">${m}</span>`
                ).join('') + (group.members.length > 10 ? ` +${group.members.length - 10}` : '');
            }
            
            chatInputBar.classList.remove('hidden');
        }
        
        function checkPendingJoin() {
            const pending = SkateChat.getPendingJoin();
            if (pending && pending.needsPassword) {
                passwordModal.classList.remove('hidden');
            }
        }
        
        // ========== GLOBAL HANDLERS ==========
        window.shareProgram = idx => {
            const p = state.filtered[idx];
            if (p) SkateChat.shareProgram(p);
        };
        
        window.voteTime = idx => {
            SkateChat.voteTime(idx);
        };
        
        window.selectGroup = id => {
            SkateChat.switchGroup(id);
            if (window.innerWidth < 768) switchView('chat');
        };
        
        window.leaveGroup = id => {
            if (confirm('Leave this group?')) {
                SkateChat.leaveGroup(id);
            }
        };
        
        window.startDM = name => {
            alert(`DM to ${name} coming soon!`);
        };
        
        // ========== EVENTS ==========
        function bindEvents() {
            // View tabs
            $$('.view-tab').forEach(tab => {
                tab.onclick = () => switchView(tab.dataset.view);
            });
            
            // Search
            $('btn-search').onclick = () => {
                state.search = searchInput.value.trim();
                applyFilters();
            };
            
            searchInput.onkeypress = e => {
                if (e.key === 'Enter') {
                    state.search = searchInput.value.trim();
                    applyFilters();
                }
            };
            
            // Type filters
            $('type-filters').onclick = e => {
                if (e.target.classList.contains('filter-chip')) {
                    $$('.filter-chip').forEach(c => c.classList.remove('active'));
                    e.target.classList.add('active');
                    state.type = e.target.dataset.type;
                    applyFilters();
                }
            };
            
            // Day/Age filters
            dayFilter.onchange = () => { state.day = dayFilter.value; applyFilters(); };
            ageFilter.onchange = () => { state.age = ageFilter.value ? parseInt(ageFilter.value) : null; applyFilters(); };
            
            // Pagination
            pagination.onclick = e => {
                if (e.target.tagName === 'BUTTON' && !e.target.disabled) {
                    state.page = parseInt(e.target.dataset.p);
                    renderPrograms();
                    $('programs-panel').scrollTop = 0;
                }
            };
            
            // Create group
            $('btn-create-group').onclick = () => {
                const name = $('group-name-input').value.trim() || 'Skating Group';
                const password = $('group-password-input').value || null;
                
                try {
                    const result = SkateChat.createGroup({ name, password });
                    shareUrlInput.value = result.shareUrl;
                    shareCard.classList.remove('hidden');
                    
                    $('group-name-input').value = '';
                    $('group-password-input').value = '';
                    
                    if (window.innerWidth < 768) switchView('chat');
                } catch (e) {
                    alert(e.message);
                }
            };
            
            $('btn-new-group').onclick = () => {
                switchView('groups');
            };
            
            // Copy URL
            $('btn-copy-url').onclick = () => {
                shareUrlInput.select();
                document.execCommand('copy');
                $('btn-copy-url').textContent = '‚úì Copied!';
                setTimeout(() => $('btn-copy-url').textContent = 'Copy Link', 2000);
            };
            
            // Share buttons
            $('btn-share').onclick = $('btn-chat-share').onclick = () => {
                const url = SkateChat.getShareUrl();
                if (url) {
                    if (navigator.share) {
                        navigator.share({ title: 'Join my skating group!', url });
                    } else {
                        shareUrlInput.value = url;
                        shareCard.classList.remove('hidden');
                        switchView('groups');
                    }
                } else {
                    switchView('groups');
                }
            };
            
            // Send message
            $('btn-send').onclick = () => {
                const text = chatInput.value.trim();
                if (text) {
                    SkateChat.sendMessage(text);
                    chatInput.value = '';
                }
            };
            
            chatInput.onkeypress = e => {
                if (e.key === 'Enter') {
                    const text = chatInput.value.trim();
                    if (text) {
                        SkateChat.sendMessage(text);
                        chatInput.value = '';
                    }
                }
            };
            
            // Password modal
            $('btn-modal-cancel').onclick = () => {
                passwordModal.classList.add('hidden');
                history.replaceState(null, '', window.location.pathname);
            };
            
            $('btn-modal-join').onclick = () => {
                const password = $('modal-password-input').value;
                if (password) {
                    try {
                        SkateChat.completePendingJoin(password);
                        passwordModal.classList.add('hidden');
                        $('modal-password-input').value = '';
                        if (window.innerWidth < 768) switchView('chat');
                    } catch (e) {
                        alert('Invalid password');
                    }
                }
            };
        }
        
        // Go!
        init();
    })();
    </script>
</body>
</html>
