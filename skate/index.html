<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Toronto Ice Skating</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <link rel="stylesheet" href="assets/css/style.css?v=9">
</head>
<body>
    <div class="app" id="app">
        <!-- Top Bar -->
        <div class="top-bar">
            <h1>Toronto Skating</h1>
            <div class="top-bar-actions">
                <span id="user-name" style="font-size:12px;color:var(--text-muted)"></span>
            </div>
        </div>
        
        <!-- Mobile Tabs -->
        <div class="view-tabs">
            <button class="view-tab active" data-view="programs">‚õ∏Ô∏è Programs</button>
            <button class="view-tab" data-view="groups">üë• Groups <span class="badge hidden" id="groups-badge">0</span></button>
            <button class="view-tab" data-view="chat">üí¨ Chat <span class="badge hidden" id="dm-badge">0</span></button>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Programs Panel -->
            <div class="view-panel active" id="programs-panel">
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="Search activities or locations...">
                    <button id="btn-search">üîç</button>
                </div>
                
                <div class="filter-row" id="type-filters">
                    <button class="filter-chip active" data-type="all">All</button>
                    <button class="filter-chip" data-type="favorites">‚ù§Ô∏è Saved</button>
                    <button class="filter-chip" data-type="leisure">Leisure</button>
                    <button class="filter-chip" data-type="hockey">Hockey</button>
                    <button class="filter-chip" data-type="figure">Figure</button>
                    <button class="filter-chip" data-type="speed">Speed</button>
                    <button class="filter-chip" data-type="adapted">Adapted</button>
                    <button class="filter-chip" data-type="ringette">Ringette</button>
                </div>
                
                <div class="filter-selects">
                    <select id="day-filter">
                        <option value="">Any Day</option>
                        <option>Sunday</option><option>Monday</option><option>Tuesday</option>
                        <option>Wednesday</option><option>Thursday</option><option>Friday</option><option>Saturday</option>
                    </select>
                    <input type="number" id="age-filter" placeholder="Age" style="max-width:80px">
                </div>
                
                <div class="stats-row" id="stats-row">
                    <div class="stats-info">
                        <span id="stats-text">Loading...</span>
                        <span id="data-updated" class="data-updated"></span>
                    </div>
                    <div class="stats-actions">
                        <button class="btn-refresh" id="btn-refresh" title="Reload from cache">üîÑ</button>
                        <a class="btn-update-data" id="btn-update-data" href="https://github.com/sunmoonron/sunmoonron.github.io/actions/workflows/update-skating-data.yml" target="_blank" title="Fetch fresh data from City of Toronto">‚¨áÔ∏è Update</a>
                    </div>
                </div>
                <ul class="program-list" id="program-list"><li class="loading">Loading...</li></ul>
                <div class="pagination" id="pagination"></div>
            </div>
            
            <!-- Groups Panel -->
            <div class="view-panel groups-panel-view" id="groups-panel">
                <!-- Public Rooms Section -->
                <div class="public-rooms">
                    <h3>üåê Public Rooms</h3>
                    <div id="public-rooms-list"></div>
                </div>
                
                <!-- Divider -->
                <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--border);">
                
                <!-- Create Private Group -->
                <div class="create-group-card" style="margin: 0 16px;">
                    <h3>üîí Create Private Group</h3>
                    <p style="font-size:12px;color:var(--text-muted)">Invite-only group for friends</p>
                    <div class="create-options">
                        <input type="text" id="group-name-input" placeholder="Group name" maxlength="30">
                        <input type="password" id="group-password-input" placeholder="Password (optional)">
                        <button class="btn-primary" id="btn-create-group">Create</button>
                    </div>
                </div>
                
                <div class="share-card hidden" id="share-card" style="margin: 16px;">
                    <label>üîó Invite friends:</label>
                    <input type="text" id="share-url-input" readonly>
                    <button id="btn-copy-url" style="width:100%">üìã Copy Invite Link</button>
                </div>
                
                <h4 style="margin:16px 16px 8px;font-size:13px;color:var(--text-muted)">Your Groups</h4>
                <ul class="groups-list" id="groups-list" style="margin:0 16px;">
                    <li style="text-align:center;padding:20px;color:var(--text-muted)">No groups yet</li>
                </ul>
            </div>
            
            <!-- Chat Panel -->
            <div class="view-panel chat-panel-view" id="chat-panel">
                <div class="chat-container">
                    <!-- Chat Header -->
                    <div class="chat-header">
                        <div class="chat-header-info">
                            <button class="btn-icon hidden" id="btn-back" style="margin-right:8px">‚Üê</button>
                            <div>
                                <h3 id="chat-title">No group selected</h3>
                                <div class="status">
                                    <span class="status-dot" id="chat-status-dot"></span>
                                    <span id="chat-status-text">--</span>
                                </div>
                            </div>
                        </div>
                        <button class="btn-icon hidden" id="btn-dm-inbox" title="Messages">üí¨</button>
                    </div>
                    
                    <!-- DM Inbox (toggleable) -->
                    <div class="dm-inbox hidden" id="dm-inbox">
                        <div class="dm-inbox-header">
                            <h4>üí¨ Direct Messages</h4>
                            <button class="btn-icon" id="btn-close-inbox">‚úï</button>
                        </div>
                        <ul class="dm-list" id="dm-list">
                            <li style="text-align:center;padding:20px;color:var(--text-muted)">No messages yet</li>
                        </ul>
                    </div>
                    
                    <!-- Messages Area -->
                    <div class="chat-messages" id="chat-messages">
                        <div class="chat-empty"><p>üë• Join or create a group to start chatting!</p></div>
                    </div>
                    
                    <!-- Members Bar -->
                    <div class="members-bar hidden" id="members-bar">
                        <span style="margin-right:4px">üë•</span>
                        <span id="members-list"></span>
                    </div>
                    
                    <!-- Input Bar -->
                    <div class="chat-input-bar hidden" id="chat-input-bar">
                        <input type="text" id="chat-input" placeholder="Type a message..." maxlength="500">
                        <button id="btn-send">‚û§</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../assets/js/nostr.bundle.js"></script>
    <script src="projects/js/profanity-list.js"></script>
    <script src="projects/js/storage.js?v=9"></script>
    <script src="projects/js/api.js?v=9"></script>
    <script src="projects/js/chat.js?v=9"></script>
    
    <script>
    (function() {
        'use strict';
        
        // ========== STATE ==========
        const app = { programs: [], filtered: [], page: 1, perPage: 25, type: 'all', search: '', day: '', age: null, view: 'programs', showInbox: false };
        
        // ========== HELPERS ==========
        const $ = id => document.getElementById(id);
        const $$ = sel => document.querySelectorAll(sel);
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function mapsUrl(location) {
            return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location + ', Toronto, ON')}`;
        }
        
        // ========== INIT ==========
        async function init() {
            try {
                const programs = await SkateAPI.getSkatingPrograms();
                app.programs = programs || [];
                app.filtered = app.programs;
                applyFilters();
                bindEvents();
                
                await SkateChat.init();
                SkateChat.onUpdate(renderChatUI);
            } catch (err) {
                $('program-list').innerHTML = `<li class="error">Error: ${err.message}</li>`;
            }
        }
        
        // ========== VIEW ==========
        function switchView(view) {
            app.view = view;
            app.showInbox = false;
            $('dm-inbox').classList.add('hidden');
            $$('.view-tab').forEach(t => t.classList.toggle('active', t.dataset.view === view));
            $$('.view-panel').forEach(p => p.classList.remove('active'));
            $(`${view}-panel`).classList.add('active');
        }
        
        // ========== PROGRAMS ==========
        function applyFilters() {
            let result = app.programs;
            
            // Favorites filter
            if (app.type === 'favorites') {
                result = result.filter(p => SkateChat.Favorites.has(p));
            } else if (app.type === 'hockey') {
                // Hockey includes shinny, ball hockey, etc.
                result = result.filter(p => {
                    const activity = (p.Activity || p['Activity Title'] || '').toLowerCase();
                    return activity.includes('shinny') || activity.includes('hockey');
                });
            } else if (app.type !== 'all') {
                result = result.filter(p => (p.Activity || p['Activity Title'] || '').toLowerCase().includes(app.type));
            }
            if (app.search) {
                const term = app.search.toLowerCase();
                result = result.filter(p => 
                    (p.Activity || p['Activity Title'] || '').toLowerCase().includes(term) ||
                    (p.LocationName || p['Location Name'] || '').toLowerCase().includes(term)
                );
            }
            if (app.day) result = result.filter(p => p['Day of Week'] === app.day);
            if (app.age !== null) result = result.filter(p => app.age >= (p['Age Min'] || 0) && app.age <= (p['Age Max'] || 999));
            
            const now = new Date(); now.setHours(0,0,0,0);
            result = result.filter(p => { const d = p['Start Date Time'] || p['Start Date']; return !d || new Date(d) >= now; });
            result.sort((a, b) => new Date(a['Start Date Time'] || a['Start Date'] || '9999') - new Date(b['Start Date Time'] || b['Start Date'] || '9999'));
            
            app.filtered = result;
            app.page = 1;
            renderPrograms();
        }
        
        function renderPrograms() {
            const { filtered, page, perPage } = app;
            const start = (page - 1) * perPage;
            const items = filtered.slice(start, start + perPage);
            const chatState = SkateChat.getState();
            const now = new Date();
            
            $('stats-text').textContent = `${filtered.length} programs found`;
            
            // Show last updated date
            const metadata = SkateAPI.getMetadata();
            if (metadata?.lastUpdated) {
                const updated = new Date(metadata.lastUpdated);
                const daysAgo = Math.floor((now - updated) / (1000 * 60 * 60 * 24));
                const dateStr = updated.toLocaleDateString('en-CA', { month: 'short', day: 'numeric' });
                $('data-updated').textContent = daysAgo === 0 ? `Updated today` : 
                    daysAgo === 1 ? `Updated yesterday` : `Updated ${dateStr}`;
                $('data-updated').classList.toggle('stale', daysAgo > 7);
            }
            
            if (filtered.length === 0) {
                const emptyMsg = app.type === 'favorites' ? 
                    'No saved programs yet. Click ‚ù§Ô∏è on any program to save it!' :
                    'No matching programs found';
                $('program-list').innerHTML = `<li class="loading">${emptyMsg}</li>`;
                $('pagination').innerHTML = '';
                return;
            }
            
            $('program-list').innerHTML = items.map((p, i) => {
                const idx = start + i;
                const activity = p.Activity || p['Activity Title'] || 'Unknown';
                const location = p.LocationName || p['Location Name'] || '';
                const dateStr = p['Start Date Time'] || p['Start Date'] || '';
                const time = p['Start Time'] || '';
                const endTime = p['End Time'] || '';
                const ageMin = p['Age Min'], ageMax = p['Age Max'];
                
                let dateDisplay = '';
                let programDate = null;
                if (dateStr) {
                    programDate = new Date(dateStr);
                    dateDisplay = programDate.toLocaleDateString('en-CA', { weekday: 'short', month: 'short', day: 'numeric' });
                }
                
                // Check if happening soon (within 2 hours)
                let happeningSoon = false;
                if (programDate && time) {
                    const [hours, mins] = time.split(':').map(Number);
                    const eventTime = new Date(programDate);
                    eventTime.setHours(hours || 0, mins || 0, 0, 0);
                    const diffMs = eventTime - now;
                    happeningSoon = diffMs > 0 && diffMs < 2 * 60 * 60 * 1000; // within 2 hours
                }
                
                // Age badge with better visibility
                let ageBadge = '<span class="age-badge all-ages">All Ages</span>';
                if (ageMin && ageMax) ageBadge = `<span class="age-badge">Ages ${ageMin}-${ageMax}</span>`;
                else if (ageMin) ageBadge = `<span class="age-badge">Ages ${ageMin}+</span>`;
                else if (ageMax) ageBadge = `<span class="age-badge">Under ${ageMax}</span>`;
                
                // Activity type tag
                const actLower = activity.toLowerCase();
                let tag = '';
                if (actLower.includes('shinny') || actLower.includes('hockey')) tag = '<span class="tag hockey">üèí Hockey</span>';
                else if (actLower.includes('figure')) tag = '<span class="tag figure">‚õ∏Ô∏è Figure</span>';
                else if (actLower.includes('speed')) tag = '<span class="tag speed">‚õ∏Ô∏è Speed</span>';
                else if (actLower.includes('leisure')) tag = '<span class="tag leisure">‚õ∏Ô∏è Leisure</span>';
                else if (actLower.includes('adapted')) tag = '<span class="tag adapted">‚ôø Adapted</span>';
                else if (actLower.includes('ringette')) tag = '<span class="tag ringette">ü•è Ringette</span>';
                
                // Happening now indicator
                const happeningBadge = happeningSoon ? '<span class="happening-now">Starting Soon</span>' : '';
                
                // Vote count
                let voteCount = 0, hasVoted = false;
                if (chatState.activeGroup?.votes?.[idx]) {
                    voteCount = chatState.activeGroup.votes[idx].length;
                    hasVoted = chatState.activeGroup.votes[idx].includes(chatState.myName);
                }
                
                // Favorite button
                const isFavorite = SkateChat.Favorites.has(p);
                const favBtn = `<button class="btn-favorite ${isFavorite ? 'active' : ''}" onclick="toggleFavorite(${idx})" title="${isFavorite ? 'Remove from saved' : 'Save this program'}">${isFavorite ? '‚ù§Ô∏è' : 'ü§ç'}</button>`;
                
                // Actions (share/vote only if in a group)
                const groupActions = chatState.activeGroup ? `
                    <button class="btn-share-program" onclick="shareProgram(${idx})" title="Share to ${chatState.activeGroup.name}">üì§ Share</button>
                    <button class="btn-vote ${hasVoted ? 'voted' : ''}" onclick="voteTime(${idx})" title="Vote for this time">üëç ${voteCount || ''}</button>
                ` : '';
                
                // Copy button
                const copyBtn = `<button class="btn-copy" onclick="copyProgram(${idx})" title="Copy details">üìã</button>`;
                
                // Make location clickable for maps
                const locationHtml = location ? 
                    `<a href="${mapsUrl(location)}" target="_blank" rel="noopener" class="program-location">üìç ${escapeHtml(location)} ‚Üó</a>` :
                    '';
                
                return `
                    <li class="program-item ${happeningSoon ? 'happening-soon' : ''}">
                        <div class="program-header">
                            <div>
                                <div class="program-title">${escapeHtml(activity)}</div>
                                ${locationHtml}
                            </div>
                            <div class="program-meta">
                                ${happeningBadge}
                                <div class="program-date">${dateDisplay}</div>
                                <div>${time}${endTime ? '-' + endTime : ''}</div>
                            </div>
                        </div>
                        <div class="program-footer">
                            <div class="program-badges">
                                ${tag}
                                ${ageBadge}
                            </div>
                            <div class="program-actions">
                                ${favBtn}
                                ${copyBtn}
                                ${groupActions}
                            </div>
                        </div>
                    </li>
                `;
            }).join('');
            
            // Pagination
            const totalPages = Math.ceil(filtered.length / perPage);
            if (totalPages <= 1) {
                $('pagination').innerHTML = '';
            } else {
                let html = `<button ${page === 1 ? 'disabled' : ''} data-p="${page - 1}">‚Äπ</button>`;
                for (let i = Math.max(1, page - 2); i <= Math.min(totalPages, page + 2); i++) {
                    html += `<button class="${i === page ? 'active' : ''}" data-p="${i}">${i}</button>`;
                }
                html += `<button ${page === totalPages ? 'disabled' : ''} data-p="${page + 1}">‚Ä∫</button>`;
                $('pagination').innerHTML = html;
            }
        }
        
        // ========== CHAT UI ==========
        function renderChatUI(chatState) {
            renderGroups(chatState);
            renderChat(chatState);
            
            // Groups badge
            const count = Object.keys(chatState.groups).length;
            $('groups-badge').textContent = count;
            $('groups-badge').classList.toggle('hidden', count === 0);
            
            // Show user name
            $('user-name').textContent = `üë§ ${chatState.myName || 'Guest'}`;
            
            // DM unread badge
            $('dm-badge').textContent = chatState.totalUnread;
            $('dm-badge').classList.toggle('hidden', chatState.totalUnread === 0);
            
            // Show DM inbox button if has any DMs
            const hasDms = Object.keys(chatState.dmThreads).length > 0;
            $('btn-dm-inbox').classList.toggle('hidden', !hasDms && !chatState.activeGroup);
            
            renderPublicRooms(chatState);
            renderPrograms();
        }
        
        function renderPublicRooms(chatState) {
            const rooms = SkateChat.getPublicRooms();
            const joinedPublicRoomIds = Object.keys(chatState.publicRooms || {});
            
            $('public-rooms-list').innerHTML = Object.entries(rooms).map(([key, room]) => {
                // Use the cached secret if available, or derive from passphrase
                const secret = chatState.publicRoomSecrets?.[key];
                const roomId = secret ? SkateChat.Crypto.deriveGroupId(secret) : null;
                const isJoined = roomId && joinedPublicRoomIds.includes(roomId);
                const publicRoom = roomId ? chatState.publicRooms?.[roomId] : null;
                const memberCount = publicRoom?.members?.length || 0;
                
                return `
                    <div class="room-card ${isJoined ? 'joined' : ''}" onclick="joinPublicRoom('${key}')">
                        <span class="room-emoji">${room.emoji}</span>
                        <div class="room-info">
                            <div class="room-name">${escapeHtml(room.name)}</div>
                            <div class="room-desc">${escapeHtml(room.desc)}</div>
                            ${isJoined ? `<div class="room-members">‚úì Joined ‚Ä¢ ${memberCount} online</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderGroups(chatState) {
            // Only show private groups in "Your Groups" list
            const privateGroups = Object.values(chatState.privateGroups || {});
            
            if (privateGroups.length === 0) {
                $('groups-list').innerHTML = '<li style="text-align:center;padding:12px;color:var(--text-muted);font-size:12px">No private groups yet</li>';
                $('share-card').classList.add('hidden');
                return;
            }
            
            $('groups-list').innerHTML = privateGroups.map(g => `
                <li class="group-item ${g.id === chatState.activeGroupId && !chatState.activeIsPublic ? 'active' : ''}">
                    <div class="group-info">
                        <h3>${escapeHtml(g.name || 'Skating Group')}</h3>
                        <div class="group-code">#${g.id.slice(0, 6).toUpperCase()}</div>
                        <div class="group-members">${g.members?.length || 1} members</div>
                    </div>
                    <div class="group-actions">
                        <button class="btn-icon" onclick="selectGroup('${g.id}')">${g.id === chatState.activeGroupId ? '‚úì' : '‚Üí'}</button>
                        <button class="btn-icon" onclick="leaveGroup('${g.id}')">‚úï</button>
                    </div>
                </li>
            `).join('');
            
            if (chatState.activeGroup && !publicSecrets.includes(chatState.activeGroup.secret)) {
                $('share-card').classList.remove('hidden');
                $('share-url-input').value = SkateChat.getShareUrl();
            } else {
                $('share-card').classList.add('hidden');
            }
        }
        
        function renderDmInbox(chatState) {
            const threads = SkateChat.getDmThreadsList();
            
            if (threads.length === 0) {
                $('dm-list').innerHTML = '<li style="text-align:center;padding:20px;color:var(--text-muted)">No messages yet</li>';
                return;
            }
            
            $('dm-list').innerHTML = threads.map(t => {
                const preview = t.lastMessage ? t.lastMessage.text.slice(0, 30) + (t.lastMessage.text.length > 30 ? '...' : '') : 'No messages';
                const time = t.lastMessage ? new Date(t.lastMessage.ts).toLocaleTimeString('en-CA', { hour: '2-digit', minute: '2-digit' }) : '';
                return `
                    <li class="dm-item ${t.unread > 0 ? 'unread' : ''}" onclick="openDm('${t.pubkey}')">
                        <div class="dm-info">
                            <strong>${escapeHtml(t.name)}</strong>
                            <span class="dm-preview">${escapeHtml(preview)}</span>
                        </div>
                        <div class="dm-meta">
                            <span class="dm-time">${time}</span>
                            ${t.unread > 0 ? `<span class="dm-unread-badge">${t.unread}</span>` : ''}
                        </div>
                    </li>
                `;
            }).join('');
        }
        
        function renderChat(chatState) {
            const { activeGroup, viewMode, activeDmThread, myName } = chatState;
            const msgs = $('chat-messages');
            const input = $('chat-input-bar');
            const members = $('members-bar');
            const backBtn = $('btn-back');
            
            // Render DM inbox if open
            if (app.showInbox) {
                renderDmInbox(chatState);
            }
            
            // DM mode
            if (viewMode === 'dm' && activeDmThread) {
                backBtn.classList.remove('hidden');
                $('chat-title').textContent = `üí¨ ${activeDmThread.name}`;
                $('chat-status-dot').className = 'status-dot online';
                $('chat-status-text').textContent = 'Private message';
                
                if (!activeDmThread.messages?.length) {
                    msgs.innerHTML = '<div class="chat-empty"><p>Start a private conversation</p></div>';
                } else {
                    msgs.innerHTML = activeDmThread.messages.map(m => `
                        <div class="chat-msg ${m.mine ? 'mine' : ''}">
                            ${!m.mine ? `<div class="sender">${escapeHtml(m.from)}</div>` : ''}
                            <div class="bubble">${escapeHtml(m.text)}</div>
                        </div>
                    `).join('');
                    msgs.scrollTop = msgs.scrollHeight;
                }
                
                members.classList.add('hidden');
                input.classList.remove('hidden');
                $('chat-input').placeholder = `Message ${activeDmThread.name}...`;
                return;
            }
            
            // Group mode
            backBtn.classList.add('hidden');
            
            if (!activeGroup) {
                $('chat-title').textContent = 'No group selected';
                $('chat-status-dot').className = 'status-dot offline';
                $('chat-status-text').textContent = 'Not connected';
                msgs.innerHTML = '<div class="chat-empty"><p>üë• Join or create a group!</p></div>';
                input.classList.add('hidden');
                members.classList.add('hidden');
                return;
            }
            
            $('chat-title').textContent = escapeHtml(activeGroup.name || 'Skating Group');
            const status = SkateChat.getConnectionStatus();
            $('chat-status-dot').className = `status-dot ${status === 'connected' ? 'online' : 'offline'}`;
            $('chat-status-text').textContent = `#${activeGroup.id.slice(0, 6).toUpperCase()} ‚Ä¢ ${status}`;
            
            // Messages
            if (!activeGroup.messages?.length) {
                msgs.innerHTML = '<div class="chat-empty"><p>No messages yet. Say hi! üëã</p></div>';
            } else {
                msgs.innerHTML = activeGroup.messages.map(m => {
                    let cls = 'chat-msg';
                    if (m.mine) cls += ' mine';
                    if (m.system) cls += ' system';
                    if (m.type === 'share') cls += ' share';
                    
                    let content = escapeHtml(m.text || '');
                    if (m.type === 'share' && m.data) {
                        const loc = m.data.location;
                        const locLink = loc ? `<a href="${mapsUrl(loc)}" target="_blank" rel="noopener">üìç ${escapeHtml(loc)} ‚Üó</a>` : '';
                        content = `
                            <strong>‚õ∏Ô∏è ${escapeHtml(m.data.activity)}</strong><br>
                            ${locLink}<br>
                            üóìÔ∏è ${escapeHtml(m.data.date || '')} ${m.data.time ? '‚Ä¢ ' + m.data.time : ''}${m.data.endTime ? '-' + m.data.endTime : ''}
                        `;
                    }
                    
                    return `
                        <div class="${cls}">
                            ${!m.mine && !m.system ? `<div class="sender">${escapeHtml(m.from)}</div>` : ''}
                            <div class="bubble">${content}</div>
                        </div>
                    `;
                }).join('');
                msgs.scrollTop = msgs.scrollHeight;
            }
            
            // Members (clickable for DM)
            if (activeGroup.members?.length > 0) {
                members.classList.remove('hidden');
                const others = activeGroup.members.filter(m => m !== myName);
                $('members-list').innerHTML = others.length > 0 ?
                    others.slice(0, 8).map(m => `<span class="member-chip" onclick="startDm('${escapeHtml(m)}')" title="Message ${escapeHtml(m)}">${escapeHtml(m)}</span>`).join('') +
                    (others.length > 8 ? ` +${others.length - 8}` : '') :
                    '<span style="color:var(--text-muted)">Just you so far</span>';
            } else {
                members.classList.add('hidden');
            }
            
            input.classList.remove('hidden');
            $('chat-input').placeholder = 'Type a message...';
        }
        
        // ========== GLOBAL ACTIONS ==========
        window.shareProgram = idx => { const p = app.filtered[idx]; if (p) SkateChat.shareProgram(p); };
        window.voteTime = idx => SkateChat.voteTime(idx);
        window.selectGroup = id => { SkateChat.switchGroup(id); if (window.innerWidth < 768) switchView('chat'); };
        window.leaveGroup = id => { if (confirm('Leave this group?')) SkateChat.leaveGroup(id); };
        window.startDm = name => { if (SkateChat.startDm(name)) { app.showInbox = false; $('dm-inbox').classList.add('hidden'); }};
        window.openDm = pubkey => {
            const thread = SkateChat.getState().dmThreads[pubkey];
            if (thread) { SkateChat.startDm(thread.name); app.showInbox = false; $('dm-inbox').classList.add('hidden'); }
        };
        
        // Join public room
        window.joinPublicRoom = async key => {
            try {
                await SkateChat.joinPublicRoom(key);
                if (window.innerWidth < 768) switchView('chat');
            } catch (e) { alert(e.message); }
        };
        
        // Favorites
        window.toggleFavorite = idx => {
            const p = app.filtered[idx];
            if (p) { SkateChat.Favorites.toggle(p); renderPrograms(); }
        };
        
        // Copy program details
        window.copyProgram = idx => {
            const p = app.filtered[idx];
            if (!p) return;
            const activity = p.Activity || p['Activity Title'] || '';
            const location = p.LocationName || p['Location Name'] || '';
            const dateStr = p['Start Date Time'] || p['Start Date'] || '';
            const time = p['Start Time'] || '';
            const date = dateStr ? new Date(dateStr).toLocaleDateString('en-CA', { weekday: 'long', month: 'long', day: 'numeric' }) : '';
            
            const text = `‚õ∏Ô∏è ${activity}\nüìç ${location}\nüóìÔ∏è ${date} ${time ? 'at ' + time : ''}\n\nFound on Toronto Skating: ${window.location.origin}${window.location.pathname}`;
            
            navigator.clipboard.writeText(text).then(() => {
                SkateChat.Notify.toast('Copied to clipboard! üìã', 'success', 2000);
            }).catch(() => {
                SkateChat.Notify.toast('Could not copy', 'error', 2000);
            });
        };
        
        // ========== EVENTS ==========
        function bindEvents() {
            $$('.view-tab').forEach(t => t.onclick = () => switchView(t.dataset.view));
            
            // Search
            $('btn-search').onclick = () => { app.search = $('search-input').value.trim(); applyFilters(); };
            $('search-input').onkeypress = e => { if (e.key === 'Enter') { app.search = $('search-input').value.trim(); applyFilters(); }};
            
            // Refresh button
            $('btn-refresh').onclick = async () => {
                $('btn-refresh').disabled = true;
                $('btn-refresh').textContent = '‚è≥';
                try {
                    SkateAPI._skatingPrograms = null; // Clear cache
                    const programs = await SkateAPI.getSkatingPrograms();
                    app.programs = programs || [];
                    app.filtered = app.programs;
                    applyFilters();
                    SkateChat.Notify.toast('Programs refreshed!', 'success', 2000);
                } catch (e) {
                    SkateChat.Notify.toast('Failed to refresh: ' + e.message, 'error');
                } finally {
                    $('btn-refresh').disabled = false;
                    $('btn-refresh').textContent = 'üîÑ';
                }
            };
            
            // Filters
            $('type-filters').onclick = e => {
                if (e.target.classList.contains('filter-chip')) {
                    $$('.filter-chip').forEach(c => c.classList.remove('active'));
                    e.target.classList.add('active');
                    app.type = e.target.dataset.type;
                    applyFilters();
                }
            };
            $('day-filter').onchange = () => { app.day = $('day-filter').value; applyFilters(); };
            $('age-filter').onchange = () => { app.age = $('age-filter').value ? parseInt($('age-filter').value) : null; applyFilters(); };
            
            // Pagination
            $('pagination').onclick = e => {
                if (e.target.tagName === 'BUTTON' && !e.target.disabled) {
                    app.page = parseInt(e.target.dataset.p);
                    renderPrograms();
                    $('programs-panel').scrollTop = 0;
                }
            };
            
            // Create group
            $('btn-create-group').onclick = () => {
                try {
                    const result = SkateChat.createGroup({
                        name: $('group-name-input').value.trim() || 'Skating Group',
                        password: $('group-password-input').value || null
                    });
                    $('share-url-input').value = result.shareUrl;
                    $('share-card').classList.remove('hidden');
                    $('group-name-input').value = '';
                    $('group-password-input').value = '';
                    if (window.innerWidth < 768) switchView('chat');
                } catch (e) {
                    SkateChat.Notify.toast(e.message, 'error');
                }
            };
            
            // Copy invite link
            $('btn-copy-url').onclick = () => {
                $('share-url-input').select();
                document.execCommand('copy');
                $('btn-copy-url').textContent = '‚úì Copied!';
                setTimeout(() => $('btn-copy-url').textContent = 'üìã Copy Invite Link', 2000);
            };
            
            // DM Inbox toggle
            $('btn-dm-inbox').onclick = () => {
                app.showInbox = !app.showInbox;
                $('dm-inbox').classList.toggle('hidden', !app.showInbox);
                if (app.showInbox) renderDmInbox(SkateChat.getState());
            };
            $('btn-close-inbox').onclick = () => {
                app.showInbox = false;
                $('dm-inbox').classList.add('hidden');
            };
            
            // Send message
            const sendMsg = () => {
                const text = $('chat-input').value.trim();
                if (!text) return;
                
                const state = SkateChat.getState();
                let sent = false;
                if (state.viewMode === 'dm') {
                    sent = SkateChat.sendDm(text);
                } else {
                    sent = SkateChat.sendMessage(text);
                }
                
                if (!sent && SkateChat.Filter.check(text)) {
                    SkateChat.Notify.toast('Message blocked: inappropriate content', 'error');
                }
                $('chat-input').value = '';
            };
            $('btn-send').onclick = sendMsg;
            $('chat-input').onkeypress = e => { if (e.key === 'Enter') sendMsg(); };
            
            // Back button (from DM or inbox)
            $('btn-back').onclick = () => { SkateChat.closeDm(); };
            
            // Keyboard shortcuts
            document.addEventListener('keydown', e => {
                // Escape to close DM or inbox
                if (e.key === 'Escape') {
                    if (app.showInbox) { app.showInbox = false; $('dm-inbox').classList.add('hidden'); }
                    else if (SkateChat.getState().viewMode === 'dm') { SkateChat.closeDm(); }
                }
                // Ctrl/Cmd + 1/2/3 to switch views
                if ((e.ctrlKey || e.metaKey) && ['1', '2', '3'].includes(e.key)) {
                    e.preventDefault();
                    const views = ['programs', 'groups', 'chat'];
                    switchView(views[parseInt(e.key) - 1]);
                }
            });
            
            // Request notification permission on first user interaction
            document.body.addEventListener('click', () => {
                SkateChat.Notify.requestPermission();
            }, { once: true });
        }
        
        // GO!
        init();
    })();
    </script>
</body>
</html>
